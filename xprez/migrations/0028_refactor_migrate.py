# Generated by Django 4.2.17 on 2025-02-28 10:12

import django.db.models.deletion
from django.core.management.color import no_style
from django.db import migrations, models
from django.utils import timezone

from xprez.migrations._operations import ContentToModule


def _content_type(obj):
    return "{}.{}".format(
        obj._meta.app_label,
        obj._meta.object_name,
    )


def _reset_sequences(schema_editor, models):
    """
    When we insert rows with explicit PKs (e.g. id=old_id), Postgres sequences
    may remain behind; later inserts that rely on the sequence can then collide.
    """
    for sql in schema_editor.connection.ops.sequence_reset_sql(no_style(), models):
        schema_editor.execute(sql)


def _module_base_attributes(module_base):
    attrs = {}
    for attr in ["section", "position", "saved", "created", "changed"]:
        attrs[attr] = getattr(module_base, attr)
    return attrs


def migrate_containers_sections_modules(apps, schema_editor):
    ContentsContainer = apps.get_model("xprez", "ContentsContainer")
    Content = apps.get_model("xprez", "Content")

    Container = apps.get_model("xprez", "Container")
    Module = apps.get_model("xprez", "Module")
    Section = apps.get_model("xprez", "Section")

    for old_container in ContentsContainer.objects.all():
        old_container_polymorph = getattr(
            old_container, old_container.content_type.lower()
        )
        container = Container.objects.create(
            id=old_container.id,
            content_type=_content_type(old_container_polymorph),
        )
        for old_content_base in Content.objects.filter(page=old_container):
            old_content = getattr(
                old_content_base, old_content_base.content_type.lower()
            )
            section = Section.objects.create(
                container=container,
                position=old_content.position,
                visible=old_content.visible,
                alternate_color=old_content.alternate_color,
                background_color=old_content.background_color,
                css_class=old_content.css_class,
                saved=True,
            )

            Module.objects.create(
                id=old_content_base.id,
                content_type=_content_type(old_content),
                section=section,
                position=0,
                saved=True,
                created=timezone.now(),
                changed=timezone.now(),
            )

    _reset_sequences(schema_editor, [Container, Module])


def reorganize_modules(apps, schema_editor):
    Module = apps.get_model("xprez", "Module")
    Content = apps.get_model("xprez", "Content")
    TextModule = apps.get_model("xprez", "TextModule")

    for module_base in Module.objects.all():
        old_content_base = Content.objects.get(id=module_base.id)
        old_content = getattr(old_content_base, old_content_base.content_type.lower())
        if old_content.content_type in ["ckeditor", "mediumeditor"]:
            new_module = TextModule(
                text=old_content.text,
                **_module_base_attributes(module_base),
            )
            new_module.content_type = _content_type(new_module)
            new_module.save()
            module_base.delete()
        elif old_content.content_type == "gridboxes":
            for index, box in enumerate(old_content.boxes):
                attributes = _module_base_attributes(module_base)
                attributes["position"] = index
                new_module = TextModule(
                    text=box,
                    **attributes,
                )
                new_module.content_type = _content_type(new_module)
                new_module.save()
            module_base.delete()
        elif old_content.content_type == "textimage":
            # TODO: convert textimage to text+gallery
            module_base.delete()
            continue
    print("---")
    for module in Module.objects.all():
        print(module.content_type)


def rename_content_types(apps, schema_editor):
    Module = apps.get_model("xprez", "Module")
    trans = {
        "xprez.CodeInput": "xprez.CodeInputModule",
        "xprez.CodeTemplate": "xprez.CodeTemplateModule",
        "xprez.Download": "xprez.DownloadModule",
        "xprez.Numbers": "xprez.NumbersModule",
        "xprez.Quote": "xprez.QuotesModule",
        "xprez.Video": "xprez.VideoModule",
    }
    for old_content_type, new_content_type in trans.items():
        Module.objects.filter(content_type=old_content_type).update(
            content_type=new_content_type
        )


class Migration(migrations.Migration):
    dependencies = [
        ("xprez", "0027_refactor_create"),
    ]

    operations = [
        migrations.RunPython(
            migrate_containers_sections_modules, migrations.RunPython.noop
        ),
        migrations.RunPython(reorganize_modules, migrations.RunPython.noop),
        migrations.RenameModel(old_name="QuoteContent", new_name="QuotesModule"),
        ContentToModule(model_name="QuotesModule"),
        migrations.RenameModel(old_name="Quote", new_name="QuotesItem"),
        migrations.RenameField(
            model_name="QuotesItem", old_name="content", new_name="module"
        ),
        migrations.AlterModelOptions(
            name="QuotesItem",
            options={"ordering": ("module", "id")},
        ),
        migrations.RenameModel(old_name="Gallery", new_name="ImagesModule"),
        ContentToModule(model_name="ImagesModule"),
        migrations.RenameModel(old_name="Photo", new_name="Image"),
        migrations.RenameField(
            model_name="Image", old_name="gallery", new_name="module"
        ),
        migrations.AlterField(
            model_name="image",
            name="module",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="images",
                to="xprez.imagesmodule",
            ),
        ),
        migrations.RenameModel(old_name="Video", new_name="VideoModule"),
        ContentToModule(model_name="VideoModule"),
        migrations.RenameModel(old_name="CodeInput", new_name="CodeInputModule"),
        ContentToModule(model_name="CodeInputModule"),
        migrations.RenameModel(old_name="NumbersContent", new_name="NumbersModule"),
        ContentToModule(model_name="NumbersModule"),
        migrations.RenameModel(old_name="Number", new_name="NumbersItem"),
        migrations.RenameField(
            model_name="NumbersItem", old_name="content", new_name="module"
        ),
        migrations.AlterModelOptions(
            name="NumbersItem",
            options={"ordering": ("module", "id")},
        ),
        migrations.RenameModel(old_name="CodeTemplate", new_name="CodeTemplateModule"),
        ContentToModule(model_name="CodeTemplateModule"),
        migrations.RenameModel(old_name="DownloadContent", new_name="DownloadModule"),
        ContentToModule(model_name="DownloadModule"),
        migrations.RenameModel(old_name="Attachment", new_name="DownloadItem"),
        migrations.RenameField(
            model_name="DownloadItem", old_name="content", new_name="module"
        ),
        migrations.AlterField(
            model_name="downloaditem",
            name="module",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="download_items",
                to="xprez.downloadmodule",
            ),
        ),
        migrations.RenameModel(old_name="ContentSymlink", new_name="ModuleSymlink"),
        ContentToModule(model_name="ModuleSymlink"),
        migrations.AlterField(
            model_name="modulesymlink",
            name="symlink",
            field=models.ForeignKey(
                editable=False,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="symlinked_module_set",
                to="xprez.module",
            ),
        ),
        migrations.RunPython(rename_content_types, migrations.RunPython.noop),
    ]
