# Generated by Django 4.2.17 on 2025-02-28 10:12

import django.db.models.deletion
from django.core.management.color import no_style
from django.db import migrations, models
from django.utils import timezone

import xprez.admin.fields
from xprez.conf import settings
from xprez.migrations._operations import ContentToModule


def _content_type(obj):
    return "{}.{}".format(
        obj._meta.app_label,
        obj._meta.object_name,
    )


def _reset_sequences(schema_editor, models):
    """
    When we insert rows with explicit PKs (e.g. id=old_id), Postgres sequences
    may remain behind; later inserts that rely on the sequence can then collide.
    """
    for sql in schema_editor.connection.ops.sequence_reset_sql(no_style(), models):
        schema_editor.execute(sql)


def migrate_containers_sections_modules(apps, schema_editor):
    ContentsContainer = apps.get_model("xprez", "ContentsContainer")
    Content = apps.get_model("xprez", "Content")

    Container = apps.get_model("xprez", "Container")
    Module = apps.get_model("xprez", "Module")
    Section = apps.get_model("xprez", "Section")

    for old_container in ContentsContainer.objects.all():
        old_container_polymorph = getattr(
            old_container, old_container.content_type.lower()
        )
        container = Container.objects.create(
            id=old_container.id,
            content_type=_content_type(old_container_polymorph),
        )
        for old_content_base in Content.objects.filter(page=old_container):
            old_content = getattr(
                old_content_base, old_content_base.content_type.lower()
            )
            section = Section.objects.create(
                container=container,
                position=old_content.position,
                visible=old_content.visible,
                alternate_color=old_content.alternate_color,
                background_color=old_content.background_color,
                css_class=old_content.css_class,
                saved=True,
            )
            section_config, _created = section.configs.get_or_create(
                css_breakpoint=settings.XPREZ_DEFAULT_BREAKPOINT
            )

            Module.objects.create(
                id=old_content_base.id,
                content_type=_content_type(old_content),
                section=section,
                position=0,
                saved=True,
                created=timezone.now(),
                changed=timezone.now(),
            )

    _reset_sequences(schema_editor, [Container, Module])


RENAMES = {
    "Gallery": "GalleryModule",
    "CodeInput": "CodeInputModule",
    "CodeTemplate": "CodeTemplateModule",
    "DownloadContent": "DownloadsModule",
    "NumbersContent": "NumbersModule",
    "Video": "VideoModule",
}

RENAMES_LOWER = {k.lower(): v for k, v in RENAMES.items()}


def rename_content_types(apps, schema_editor):
    Module = apps.get_model("xprez", "Module")
    for old_content_type, new_content_type in RENAMES.items():
        old_content_type = f"xprez.{old_content_type}"
        new_content_type = f"xprez.{new_content_type}"
        Module.objects.filter(content_type=old_content_type).update(
            content_type=new_content_type
        )


class ModuleProcessorBase:
    old_content_class = None

    WIDTH_TRANS = {
        "full": "full",
        "mid": "medium",
        "text": "small",
    }

    def __init__(self, apps, module_base):
        self.apps = apps
        self.module_base = module_base
        self.module_class = self.apps.get_model(*module_base.content_type.split("."))
        self.module = self.module_class.objects.get(id=module_base.id)
        self.load_old_content()

    def load_old_content(self):
        Content = self.apps.get_model("xprez", "Content")
        self.old_content_base = Content.objects.get(id=self.module_base.id)

        old_content_attr = self.old_content_base.content_type.lower()
        if old_content_attr in RENAMES_LOWER:
            old_content_class = self.apps.get_model(
                "xprez", RENAMES_LOWER[old_content_attr]
            )
            self.old_content = old_content_class.objects.get(
                id=self.old_content_base.id
            )
        else:
            self.old_content = getattr(self.old_content_base, old_content_attr)

    def process(self):
        raise NotImplementedError()

    def get_config_class(self, module):
        return "xprez.ModuleConfig"

    def create_config(self, module):
        config_class = self.apps.get_model(*self.get_config_class(module).split("."))
        self.config, _created = config_class.objects.get_or_create(
            module=module, css_breakpoint=settings.XPREZ_DEFAULT_BREAKPOINT
        )


class SimpleModuleProcessor(ModuleProcessorBase):
    def process(self):
        self.create_config(self.module)


class ModuleReplaceProcessor(ModuleProcessorBase):
    """
    Replace a module with a new module(s).
    """

    def process(self):
        self.new_modules = self.prepare_new_modules()
        self.finalize_new_modules()
        self.delete_processed_module()

    def prepare_new_modules(self):
        raise NotImplementedError()

    def finalize_new_modules(self):
        for new_module in self.new_modules:
            new_module.content_type = _content_type(new_module)
            new_module.section = self.module_base.section
            new_module.saved = True
            new_module.created = timezone.now()
            new_module.changed = timezone.now()
            new_module.save()
            self.create_config(new_module)

    def delete_processed_module(self):
        self.module_base.delete()


class TextModuleProcessorBase(ModuleReplaceProcessor):
    def get_config_class(self, module):
        return "xprez.TextConfig"

    def prepare_new_modules(self, **kwargs):
        TextModule = self.apps.get_model("xprez", "TextModule")
        return [TextModule(text=self.old_content.text)]


class CkEditorProcessor(TextModuleProcessorBase):
    pass


class MediumEditorProcessor(TextModuleProcessorBase):
    pass


class GridboxesProcessor(TextModuleProcessorBase):
    def prepare_new_modules(self):
        TextModule = self.apps.get_model("xprez", "TextModule")
        new_modules = []
        for index, box in enumerate(self.old_content.boxes):
            new_modules += [TextModule(position=index, text=box)]
        return new_modules


class QuotesProcessor(ModuleReplaceProcessor):
    def prepare_new_modules(self):
        QuoteModule = self.apps.get_model("xprez", "QuoteModule")
        quotes = self.old_content.quotes.all()
        if not self.old_content.display_two:
            quotes = quotes[:1]

        if len(quotes) > 1:
            self.module_base.section.configs.get_or_create(
                css_breakpoint=settings.XPREZ_DEFAULT_BREAKPOINT
            )[0].columns = 2
            self.module_base.section.save()

        new_modules = []
        for index, quote in enumerate(quotes):
            new_modules += [
                QuoteModule(
                    position=index,
                    name=quote.name,
                    job_title=quote.job_title,
                    image=quote.image,
                    title=quote.title,
                    quote=quote.quote,
                )
            ]
        return new_modules


class TextImageProcessor(ModuleReplaceProcessor):
    def prepare_new_modules(self):
        # TODO
        return []
        # TextModule = self.apps.get_model("xprez", "TextModule")
        # GalleryModule = self.apps.get_model("xprez", "GalleryModule")

        # return [
        #     self.new_module(text=self.old_content.text, image=self.old_content.image)
        # ]


class GalleryProcessor(SimpleModuleProcessor):
    GAP_TRANS = {True: "small", False: ""}
    CROP_TRANS = {True: "4:3", False: ""}

    def process(self):
        super().process()
        section_config = self.module.section.configs.get(
            css_breakpoint=settings.XPREZ_DEFAULT_BREAKPOINT
        )
        section_config.max_width_choice = self.WIDTH_TRANS[self.old_content.width]
        section_config.columns = self.old_content.columns
        section_config.gap_choice = self.GAP_TRANS[self.old_content.divided]
        section_config.save()

        self.module.crop = self.CROP_TRANS[self.old_content.crop_old]
        self.module.save()

        self.config.gap_choice = self.GAP_TRANS[self.old_content.divided]
        self.config.save()

    def get_config_class(self, module):
        return "xprez.GalleryConfig"


class DownloadModuleProcessor(SimpleModuleProcessor):
    pass


class ModuleSymlinkProcessor(SimpleModuleProcessor):
    def process(self):
        super().process()
        print("TODO: process module symlink")


class UnknownModuleProcessor(ModuleProcessorBase):
    def process(self):
        print("TODO: unknown module", self.module_base.content_type)


PROCESSORS = {
    "xprez.CkEditor": CkEditorProcessor,
    "xprez.MediumEditor": MediumEditorProcessor,
    "xprez.GridBoxes": GridboxesProcessor,
    "xprez.QuoteContent": QuotesProcessor,
    "xprez.TextImage": TextImageProcessor,
    "xprez.GalleryModule": GalleryProcessor,
    "xprez.VideoModule": SimpleModuleProcessor,
    "xprez.CodeInputModule": SimpleModuleProcessor,
    "xprez.NumbersModule": SimpleModuleProcessor,
    "xprez.CodeTemplateModule": SimpleModuleProcessor,
    "xprez.DownloadsModule": DownloadModuleProcessor,
    "xprez.ModuleSymlink": ModuleSymlinkProcessor,
}


def process_modules(apps, schema_editor):
    Module = apps.get_model("xprez", "Module")
    for module_base in Module.objects.all():
        processor = PROCESSORS.get(module_base.content_type, UnknownModuleProcessor)(
            apps, module_base
        )
        processor.process()


class Migration(migrations.Migration):
    dependencies = [
        ("xprez", "0027_refactor_create"),
    ]

    operations = [
        migrations.RunPython(
            migrate_containers_sections_modules, migrations.RunPython.noop
        ),
        migrations.RenameModel(old_name="Gallery", new_name="GalleryModule"),
        ContentToModule(model_name="GalleryModule"),
        migrations.RenameModel(old_name="Photo", new_name="GalleryItem"),
        migrations.RenameField(
            model_name="GalleryItem", old_name="gallery", new_name="module"
        ),
        migrations.RenameField(
            model_name="GalleryItem", old_name="image", new_name="file"
        ),
        migrations.AlterField(
            model_name="GalleryItem",
            name="file",
            field=models.ImageField(upload_to="gallery"),
        ),
        migrations.AlterField(
            model_name="GalleryItem",
            name="module",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="items",
                to="xprez.GalleryModule",
            ),
        ),
        migrations.RenameField(
            model_name="GalleryModule",
            old_name="crop",
            new_name="crop_old",
        ),
        migrations.AddField(
            model_name="gallerymodule",
            name="crop",
            field=models.CharField(
                choices=[
                    ("", "None"),
                    ("1:1", "1:1"),
                    ("3:2", "3:2"),
                    ("4:3", "4:3"),
                    ("16:9", "16:9"),
                ],
                default="",
                max_length=5,
            ),
        ),
        migrations.RenameModel(old_name="Video", new_name="VideoModule"),
        ContentToModule(model_name="VideoModule"),
        migrations.RenameModel(old_name="CodeInput", new_name="CodeInputModule"),
        ContentToModule(model_name="CodeInputModule"),
        migrations.RenameModel(old_name="NumbersContent", new_name="NumbersModule"),
        ContentToModule(model_name="NumbersModule"),
        migrations.RenameModel(old_name="Number", new_name="NumbersItem"),
        migrations.RenameField(
            model_name="NumbersItem", old_name="content", new_name="module"
        ),
        migrations.AlterField(
            model_name="numbersitem",
            name="module",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="items",
                to="xprez.numbersmodule",
            ),
        ),
        migrations.AlterModelOptions(
            name="NumbersItem",
            options={"ordering": ("module", "id")},
        ),
        migrations.RenameModel(old_name="CodeTemplate", new_name="CodeTemplateModule"),
        ContentToModule(model_name="CodeTemplateModule"),
        migrations.AlterField(
            model_name="codetemplatemodule",
            name="template_name",
            field=xprez.admin.fields.TemplatePathField(
                blank=True, match="^(?!\\.).+", max_length=255, null=True
            ),
        ),
        migrations.RenameModel(old_name="DownloadContent", new_name="DownloadsModule"),
        ContentToModule(model_name="DownloadsModule"),
        migrations.RenameModel(old_name="Attachment", new_name="DownloadsItem"),
        migrations.RenameField(
            model_name="DownloadsItem", old_name="content", new_name="module"
        ),
        migrations.AlterField(
            model_name="DownloadsItem",
            name="module",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="items",
                to="xprez.DownloadsModule",
            ),
        ),
        migrations.RenameModel(old_name="ContentSymlink", new_name="ModuleSymlink"),
        ContentToModule(model_name="ModuleSymlink"),
        migrations.AlterField(
            model_name="modulesymlink",
            name="symlink",
            field=models.ForeignKey(
                editable=False,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="symlinked_module_set",
                to="xprez.Module",
            ),
        ),
        migrations.RunPython(rename_content_types, migrations.RunPython.noop),
        migrations.RunPython(process_modules, migrations.RunPython.noop),
    ]
